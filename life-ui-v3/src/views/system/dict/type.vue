<template>
  <div class="koi-flex">
    <KoiCard>
      <!-- ÊêúÁ¥¢Êù°‰ª∂ -->
      <el-form v-show="showSearch" :inline="true">
        <el-form-item label="Â≠óÂÖ∏ÂêçÁß∞" prop="lovName">
          <el-input
            placeholder="ËØ∑ËæìÂÖ•Â≠óÂÖ∏ÂêçÁß∞"
            v-model="searchParams.lovName"
            clearable
            style="width: 240px"
            @keyup.enter.native="handleListPage"
          ></el-input>
        </el-form-item>
        <el-form-item label="Â≠óÂÖ∏ÁºñÁ†Å" prop="lovCode">
          <el-input
            placeholder="ËØ∑ËæìÂÖ•Â≠óÂÖ∏ÁºñÁ†Å"
            v-model="searchParams.lovCode"
            clearable
            style="width: 240px"
            @keyup.enter.native="handleListPage"
          ></el-input>
        </el-form-item>
        <el-form-item label="Â≠óÂÖ∏Áä∂ÊÄÅ" prop="enabledFlag">
          <el-select
            placeholder="ËØ∑ÈÄâÊã©Â≠óÂÖ∏Áä∂ÊÄÅ"
            v-model="searchParams.enabledFlag"
            clearable
            style="width: 240px"
            @keyup.enter.native="handleListPage"
          >
            <el-option label="ÂêØÁî®" :value="true" />
            <el-option label="ÂÅúÁî®" :value="false" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="search" plain v-debounce="handleSearch">ÊêúÁ¥¢</el-button>
          <el-button type="danger" icon="refresh" plain v-throttle="resetSearch">ÈáçÁΩÆ</el-button>
        </el-form-item>
      </el-form>

      <!-- Ë°®Ê†ºÂ§¥ÈÉ®ÊåâÈíÆ -->
      <el-row :gutter="10">
        <el-col :span="1.5" v-auth="['system:role:add']">
          <el-button type="primary" icon="plus" plain @click="handleAdd()">Êñ∞Â¢û</el-button>
        </el-col>
        <el-col :span="1.5" v-auth="['system:role:delete']">
          <el-button type="danger" icon="delete" plain @click="handleBatchDelete()" :disabled="multiple">Âà†Èô§</el-button>
        </el-col>
        <KoiToolbar v-model:showSearch="showSearch" @refreshTable="handleListPage"></KoiToolbar>
      </el-row>

      <div class="h-20px"></div>
      <!-- Êï∞ÊçÆË°®Ê†º -->
      <el-table
        v-loading="loading"
        border
        :data="tableList"
        empty-text="ÊöÇÊó∂Ê≤°ÊúâÊï∞ÊçÆÂìüüåª"
        @selection-change="handleSelectionChange"
      >
        <el-table-column type="selection" width="55" align="center" />
        <el-table-column label="Â≠óÂÖ∏ÂêçÁß∞" prop="lovName" width="120" align="center"></el-table-column>
        <el-table-column label="Â≠óÂÖ∏ÁºñÁ†Å" prop="lovCode" width="180" align="center">
          <template #default="scope">
            <RouterLink :to="`/system/dict/data/${scope.row.lovId}`">
              <span>{{ scope.row.lovCode }}</span>
            </RouterLink>
          </template>
        </el-table-column>
        <el-table-column label="Â≠óÂÖ∏Á±ªÂûã" prop="lovTypeCodeContent" width="90" align="center"></el-table-column>
        <el-table-column
          label="Â≠óÂÖ∏Â§áÊ≥®"
          prop="description"
          width="230"
          :show-overflow-tooltip="true"
          align="center"
        ></el-table-column>
        <el-table-column label="ÂàõÂª∫Êó∂Èó¥" prop="createdTime" width="175" align="center"></el-table-column>
        <!-- Ê≥®ÊÑèÔºöÂ¶ÇÊûúÂêéÁ´ØÊï∞ÊçÆËøîÂõûÁöÑÊòØÂ≠óÁ¨¶‰∏≤"0" OR "1"ÔºåËøôÈáåÁöÑactive-value AND inactive-value‰∏çÈúÄË¶ÅÂä†ÂÜíÂè∑Ôºå‰ºöËÆ§‰∏∫ÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂê¶ÂàôÔºöÂêéÁ´ØËøîÂõûÊòØ0 AND 1Êï∞Â≠óÔºåÂàôÈúÄË¶ÅÊ∑ªÂä†ÂÜíÂè∑ -->
        <el-table-column label="Â≠óÂÖ∏Áä∂ÊÄÅ" prop="enabledFlag" width="100" align="center">
          <template #default="scope">
            <KoiTag :tagOptions="koiDicts.FLAG_STATUS" :value="scope.row.enabledFlag" ></KoiTag>
          </template>
        </el-table-column>
        <el-table-column label="‰øÆÊîπÊó∂Èó¥" prop="updatedTime" width="175" align="center"></el-table-column>
        <el-table-column label="Êìç‰Ωú" align="center" width="130" fixed="right">
          <template #default="{ row }">
            <el-tooltip content="‰øÆÊîπüåª" placement="top">
              <el-button
                type="primary"
                icon="Edit"
                circle
                plain
                @click="handleUpdate(row)"
                v-auth="['system:role:update']"
              ></el-button>
            </el-tooltip>
            <el-tooltip content="Âà†Èô§üåª" placement="top">
              <el-button
                type="danger"
                icon="Delete"
                circle
                plain
                @click="handleDelete(row)"
                v-auth="['system:role:delete']"
              ></el-button>
            </el-tooltip>
          </template>
        </el-table-column>
      </el-table>

      <div class="h-20px"></div>
      <!-- {{ searchParams.pageNo }} --- {{ searchParams.pageSize }} -->
      <!-- ÂàÜÈ°µ -->
      <el-pagination
        background
        v-model:current-page="searchParams.pageNo"
        v-model:page-size="searchParams.pageSize"
        v-show="total > 0"
        :page-sizes="[10, 20, 50, 100, 200]"
        layout="total, sizes, prev, pager, next, jumper"
        :total="total"
        @size-change="handleListPage"
        @current-change="handleListPage"
      />

      <!-- Ê∑ªÂä† OR ‰øÆÊîπ -->
      <KoiDrawer
        ref="koiDrawerRef"
        :title="title"
        @koiConfirm="handleConfirm"
        @koiCancel="handleCancel"
        :loading="confirmLoading"
      >
        <template #content>
          <el-form ref="formRef" :rules="rules" :model="form" label-width="80px" status-icon>
            <el-row>
              <el-col :sm="{ span: 24 }" :xs="{ span: 24 }">
                <el-form-item label="Â≠óÂÖ∏ÂêçÁß∞" prop="lovName">
                  <el-input v-model="form.lovName" placeholder="ËØ∑ËæìÂÖ•Â≠óÂÖ∏ÂêçÁß∞" clearable />
                </el-form-item>
              </el-col>
              <el-col :sm="{ span: 24 }" :xs="{ span: 24 }">
                <el-form-item label="Â≠óÂÖ∏ÁºñÁ†Å" prop="lovCode">
                  <el-input v-model="form.lovCode" placeholder="ËØ∑ËæìÂÖ•Â≠óÂÖ∏ÁºñÁ†Å" clearable />
                </el-form-item>
              </el-col>
              <el-col :sm="{ span: 24 }" :xs="{ span: 24 }">
                <el-form-item label="Â≠óÂÖ∏Á±ªÂûã" prop="lovTypeCode">
                  <el-select v-model="form.lovTypeCode" placeholder="ËØ∑ÈÄâÊã©Â≠óÂÖ∏Á±ªÂûã" clearable>
                    <el-option label="Âõ∫ÂÆöÂÄº" value="FIXED" />
                    <el-option label="ÈìæÊé•" value="URL" />
                  </el-select>
                </el-form-item>
              </el-col>
              <el-col :sm="{ span: 24 }" :xs="{ span: 24 }">
                <el-form-item label="Â≠óÂÖ∏Áä∂ÊÄÅ" prop="enabledFlag">
                  <el-select v-model="form.enabledFlag" placeholder="ËØ∑ÈÄâÊã©Â≠óÂÖ∏Áä∂ÊÄÅ" clearable>
                    <el-option label="ÂêØÁî®" :value="true" />
                    <el-option label="ÂÅúÁî®" :value="false" />
                  </el-select>
                </el-form-item>
              </el-col>
              <el-col :sm="{ span: 24 }" :xs="{ span: 24 }">
                <el-form-item label="Â≠óÂÖ∏Â§áÊ≥®" prop="description">
                  <el-input v-model="form.description" :rows="5" type="textarea" placeholder="ËØ∑ËæìÂÖ•Â≠óÂÖ∏Â§áÊ≥®" />
                </el-form-item>
              </el-col>
            </el-row>
          </el-form>
          <!--          {{ form }}-->
        </template>
      </KoiDrawer>
    </KoiCard>
  </div>
</template>

<script setup lang="ts" name="dictTypePage">
// Â≠óÂÖ∏‰∏ªË°®È°µÈù¢
import { nextTick, onMounted, reactive, ref } from "vue";
import {
  koiMsgBox,
  koiMsgError,
  koiMsgInfo,
  koiMsgSuccess,
  koiMsgWarning,
  koiNoticeError,
  koiNoticeSuccess
} from "@/utils/koi.ts";
// @ts-ignore
import { add, batchDelete, getById, listPage, update } from "@/api/system/dict/index.ts";
import { useKoiDict } from "@/hooks/dicts/index.ts";

const { koiDicts } = useKoiDict(["FLAG_STATUS"]);

// Ë°®Ê†ºÂä†ËΩΩÂä®ÁîªLoading
const loading = ref(false);
// ÊòØÂê¶ÊòæÁ§∫ÊêúÁ¥¢Ë°®Âçï[ÈªòËÆ§ÊòæÁ§∫]
const showSearch = ref<boolean>(true); // ÈªòËÆ§ÊòæÁ§∫ÊêúÁ¥¢Êù°‰ª∂
// Ë°®Ê†ºÊï∞ÊçÆ
const tableList = ref<any>([]);

// Êü•ËØ¢ÂèÇÊï∞
const searchParams = ref({
  pageNo: 1, // Á¨¨Âá†È°µ
  pageSize: 10, // ÊØèÈ°µÊòæÁ§∫Â§öÂ∞ëÊù°
  lovName: "",
  lovCode: "",
  enabledFlag: null
});

const total = ref<number>(0);

/** ÈáçÁΩÆÊêúÁ¥¢ÂèÇÊï∞ */
const resetSearchParams = () => {
  searchParams.value = {
    pageNo: 1,
    pageSize: 10,
    lovName: "",
    lovCode: "",
    enabledFlag: null
  };
};

/** ÊêúÁ¥¢ */
const handleSearch = () => {
  console.log("ÊêúÁ¥¢");
  searchParams.value.pageNo = 1;
  handleListPage();
};

/** ÈáçÁΩÆ */
const resetSearch = () => {
  console.log("ÈáçÁΩÆÊêúÁ¥¢");
  resetSearchParams();
  handleListPage();
};

/** @current-changeÔºöÁÇπÂáªÂàÜÈ°µÁªÑ‰ª∂È°µÁ†ÅÂèëÁîüÂèòÂåñÔºö‰æãÂ¶ÇÔºöÂàáÊç¢Á¨¨2„ÄÅ3È°µ OR ‰∏ä‰∏ÄÈ°µ AND ‰∏ã‰∏ÄÈ°µ OR Ë∑≥ËΩ¨Êüê‰∏ÄÈ°µ */
/** @size-changeÔºöÁÇπÂáªÂàÜÈ°µÁªÑ‰ª∂‰∏ãÊãâÈÄâ‰∏≠Êù°Êï∞ÂèëÁîüÂèòÂåñÔºö‰æãÂ¶ÇÔºöÈÄâÊã©10Êù°/È°µ„ÄÅ20Êù°/È°µÁ≠â */
// ÂàÜÈ°µÊü•ËØ¢Ôºå@current-change AND @size-changeÈÉΩ‰ºöËß¶ÂèëÂàÜÈ°µÔºåË∞ÉÁî®ÂêéÁ´ØÂàÜÈ°µÊé•Âè£
/** Êï∞ÊçÆË°®Ê†º */
const handleListPage = async () => {
  total.value = 400;
  try {
    loading.value = true;
    tableList.value = []; // ÈáçÁΩÆË°®Ê†ºÊï∞ÊçÆ
    const res: any = await listPage(searchParams.value);
    console.log("Â≠óÂÖ∏Êï∞ÊçÆË°®Ê†ºÊï∞ÊçÆ->", res.data);
    tableList.value = res.data.list;
    total.value = res.data.total;
    loading.value = false;
  } catch (error) {
    console.log(error);
    koiNoticeError("Êï∞ÊçÆÊü•ËØ¢Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
  }
};

/** Êï∞ÊçÆË°®Ê†º[Âà†Èô§„ÄÅÊâπÈáèÂà†Èô§Á≠âÂà∑Êñ∞‰ΩøÁî®] */
const handleTableData = async () => {
  try {
    const res: any = await listPage(searchParams.value);
    console.log("Â≠óÂÖ∏Êï∞ÊçÆË°®Ê†ºÊï∞ÊçÆ->", res.data);
    tableList.value = res.data.list;
    total.value = res.data.total;
  } catch (error) {
    console.log(error);
    koiNoticeError("Êï∞ÊçÆÊü•ËØ¢Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
  }
};

// ÈùôÊÄÅÈ°µÈù¢Èò≤Ê≠¢Êä•Èîô(ÂèØÁõ¥Êé•Âà†Èô§)
// @ts-ignore
const handleStaticPage = () => {
  listPage(searchParams.value);
};

onMounted(() => {
  // Ëé∑ÂèñË°®Ê†ºÊï∞ÊçÆ
  handleListPage();
});

const ids = ref([]); // ÈÄâ‰∏≠Êï∞ÁªÑ
const single = ref<boolean>(true); // ÈùûÂçï‰∏™Á¶ÅÁî®
const multiple = ref<boolean>(true); // ÈùûÂ§ö‰∏™Á¶ÅÁî®

/** ÊòØÂê¶Â§öÈÄâ */
const handleSelectionChange = (selection: any) => {
  // console.log(selection);
  ids.value = selection.map((item: any) => item.lovId);
  single.value = selection.length != 1; // ÂçïÈÄâ
  multiple.value = !selection.length; // Â§öÈÄâ
};

/** Ê∑ªÂä† */
const handleAdd = () => {
  // ÊâìÂºÄÊäΩÂ±â
  koiDrawerRef.value.koiOpen();
  koiMsgSuccess("Ê∑ªÂä†üåª");
  // ÈáçÁΩÆË°®Âçï
  resetForm();
  // Ê†áÈ¢ò
  title.value = "Â≠óÂÖ∏Ê∑ªÂä†";
  form.value.enabledFlag = true;
};

/** ÂõûÊòæÊï∞ÊçÆ */
const handleEcho = async (id: any) => {
  console.log("ÂõûÊòæÊï∞ÊçÆID", id);
  if (id == null || id == "") {
    koiMsgWarning("ËØ∑ÈÄâÊã©ÈúÄË¶Å‰øÆÊîπÁöÑÊï∞ÊçÆüåª");
    return;
  }
  try {
    const res: any = await getById({ lovId: id });
    console.log(res.data);
    form.value = res.data;
  } catch (error) {
    koiNoticeError("Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
    console.log(error);
  }
};

/** ‰øÆÊîπ */
const handleUpdate = async (row?: any) => {
  // ÊâìÂºÄÊäΩÂ±â
  koiDrawerRef.value.koiOpen();
  koiMsgSuccess("‰øÆÊîπüåª");
  // ÈáçÁΩÆË°®Âçï
  resetForm();
  // Ê†áÈ¢ò
  title.value = "Â≠óÂÖ∏‰øÆÊîπ";
  const lovId = row ? row.lovId : ids.value[0];
  if (lovId == null || lovId == "") {
    koiMsgError("ËØ∑ÈÄâ‰∏≠ÈúÄË¶Å‰øÆÊîπÁöÑÊï∞ÊçÆüåª");
  }
  console.log(lovId);
  // ÂõûÊòæÊï∞ÊçÆ
  handleEcho(lovId);
};

// Ê∑ªÂä† OR ‰øÆÊîπÊäΩÂ±âRef
const koiDrawerRef = ref();
// Ê†áÈ¢ò
const title = ref("Â≠óÂÖ∏Á±ªÂûãÁÆ°ÁêÜ");
// formË°®ÂçïRef
const formRef = ref<any>();
// formË°®Âçï
let form = ref<any>({
  lovId: "",
  lovTypeCode: "",
  lovCode: "",
  lovName: "",
  enabledFlag: "",
  description: ""
});

/** Ê∏ÖÁ©∫Ë°®ÂçïÊï∞ÊçÆ */
const resetForm = () => {
  // Á≠âÂæÖ DOM Êõ¥Êñ∞ÂÆåÊàê
  nextTick(() => {
    if (formRef.value) {
      // ÈáçÁΩÆËØ•Ë°®ÂçïÈ°πÔºåÂ∞ÜÂÖ∂ÂÄºÈáçÁΩÆ‰∏∫ÂàùÂßãÂÄºÔºåÂπ∂ÁßªÈô§Ê†°È™åÁªìÊûú
      formRef.value.resetFields();
    }
  });
  form.value = {
    lovId: "",
    lovTypeCode: "",
    lovCode: "",
    lovName: "",
    enabledFlag: "",
    description: ""
  };
};

/** Ë°®ÂçïËßÑÂàô */
const rules = reactive({
  lovTypeCode: [{ required: true, message: "ËØ∑ËæìÂÖ•Â≠óÂÖ∏Á±ªÂûã", trigger: "blur" }],
  lovCode: [{ required: true, message: "ËØ∑ËæìÂÖ•Â≠óÂÖ∏ÁºñÁ†Å", trigger: "blur" }],
  lovName: [{ required: true, message: "ËØ∑ËæìÂÖ•Â≠óÂÖ∏ÂêçÂ≠ó", trigger: "blur" }],
  enabledFlag: [{ required: true, message: "ËØ∑ËæìÂÖ•ÈÄâÊã©Â≠óÂÖ∏Áä∂ÊÄÅ", trigger: "blur" }],
  description: [{ required: true, message: "ËØ∑ËæìÂÖ•Â≠óÂÖ∏ÊèèËø∞", trigger: "blur" }]
});

// Á°ÆÂÆöÊåâÈíÆÊòØÂê¶ÊòæÁ§∫Loading
const confirmLoading = ref(false);

/** Á°ÆÂÆö  */
const handleConfirm = () => {
  if (!formRef.value) return;
  confirmLoading.value = true;
  (formRef.value as any).validate(async (valid: any) => {
    if (valid) {
      console.log("Ë°®ÂçïID", form.value.lovId);
      if (form.value.lovId != null && form.value.lovId != "") {
        try {
          await update(form.value);
          koiNoticeSuccess("‰øÆÊîπÊàêÂäüüåª");
          confirmLoading.value = false;
          koiDrawerRef.value.koiQuickClose();
          resetForm();
          handleListPage();
        } catch (error) {
          console.log(error);
          confirmLoading.value = false;
          koiNoticeError("‰øÆÊîπÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
        }
      } else {
        try {
          await add(form.value);
          koiNoticeSuccess("Ê∑ªÂä†ÊàêÂäüüåª");
          confirmLoading.value = false;
          koiDrawerRef.value.koiQuickClose();
          resetForm();
          handleListPage();
        } catch (error) {
          console.log(error);
          confirmLoading.value = false;
          koiNoticeError("Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØïüåª");
        }
      }
    } else {
      koiMsgError("È™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Â°´ÂÜôÂÜÖÂÆπüåª");
      confirmLoading.value = false;
    }
  });
};

/** ÂèñÊ∂à */
const handleCancel = () => {
  koiDrawerRef.value.koiClose();
};

/** Âà†Èô§ */
const handleDelete = (row: any) => {
  const id = row.lovId;
  if (id == null || id == "") {
    koiMsgWarning("ËØ∑ÈÄâ‰∏≠ÈúÄË¶ÅÂà†Èô§ÁöÑÊï∞ÊçÆüåª");
    return;
  }
  koiMsgBox("ÊÇ®Á°ÆËÆ§ÈúÄË¶ÅÂà†Èô§Â≠óÂÖ∏ÂêçÁß∞[" + row.lovName + "]‰πàÔºü")
    .then(async () => {
      const res: any = await batchDelete([id]);
      if (res.code !== "0") {
        return;
      }
      koiNoticeSuccess("Âà†Èô§ÊàêÂäüüåª");
      resetForm();
      handleListPage();
    })
    .catch(() => {
      koiMsgError("Â∑≤ÂèñÊ∂àüåª");
    });
};

/** ÊâπÈáèÂà†Èô§ */
const handleBatchDelete = () => {
  if (ids.value.length == 0) {
    koiMsgInfo("ËØ∑ÈÄâÊã©ÈúÄË¶ÅÂà†Èô§ÁöÑÊï∞ÊçÆüåª");
    return;
  }
  koiMsgBox("ÊÇ®Á°ÆËÆ§ÈúÄË¶ÅËøõË°åÊâπÈáèÂà†Èô§‰πàÔºü")
    .then(async () => {
      const res: any = await batchDelete(ids.value);
      if (res.code !== "0") {
        return;
      }
      koiNoticeSuccess("ÊâπÈáèÂà†Èô§ÊàêÂäüüåª");
      handleTableData();
    })
    .catch(() => {
      koiMsgError("Â∑≤ÂèñÊ∂àüåª");
    });
};
</script>

<style lang="scss" scoped></style>
